<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>テキサスホールデム・アルティメット</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --poker-green: #1a472a; --accent: #f1c40f; --card-red: #c0392b; }
        body { font-family: sans-serif; background: var(--poker-green); color: white; margin: 0; text-align: center; overflow-x: hidden; }
        .screen { display: none; padding: 15px; min-height: 100vh; box-sizing: border-box; flex-direction: column; align-items: center; }
        .active { display: flex; }
        
        button { padding: 12px; font-size: 16px; cursor: pointer; border-radius: 8px; border: none; background: #27ae60; color: white; margin: 5px; width: 90%; max-width: 280px; box-shadow: 0 4px #1e8449; transition: 0.1s; }
        button:active { transform: translateY(2px); box-shadow: 0 2px #1e8449; }
        .btn-blue { background: #2980b9; box-shadow: 0 4px #1a5276; }
        .btn-orange { background: #e67e22; box-shadow: 0 4px #a04000; }
        .btn-red { background: #c0392b; box-shadow: 0 4px #7b241c; }
        input { padding: 12px; font-size: 18px; border-radius: 8px; border: 1px solid #ccc; width: 250px; margin-bottom: 20px; text-align: center; color: black; }

        .card { 
            width: 60px; height: 90px; background: white; border-radius: 6px; color: black; 
            display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; 
            box-shadow: 0 3px 6px rgba(0,0,0,0.4); position: relative;
        }
        .card.back { background: var(--card-red) !important; border: 3px solid white; color: white !important; }
        .suit-red { color: #e74c3c; }

        .slots-container { display: flex; justify-content: space-around; width: 100%; margin-bottom: 10px; }
        .slot { width: 70px; height: 70px; border-radius: 50%; border: 2px dashed rgba(255,255,255,0.4); font-size: 11px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .slot.connected { border-style: solid; border-color: var(--accent); background: rgba(241,196,15,0.1); }

        .area-label { font-size: 12px; color: var(--accent); margin-top: 15px; margin-bottom: 5px; text-transform: uppercase; }
        .card-row { display: flex; gap: 8px; justify-content: center; min-height: 100px; width: 100%; flex-wrap: wrap; }

        #hand-rank { font-size: 22px; font-weight: bold; color: var(--accent); margin: 15px 0; height: 30px; text-shadow: 2px 2px 4px black; }

        #qr-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
        #qrcode-canvas { background: white; padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>

    <div id="choice-screen" class="screen active">
        <h1 style="margin-top:50px;">Texas Hold'em</h1>
        <button onclick="goParentAuth()">親（ディーラー）</button>
        <button onclick="goChildScanner()">子（プレイヤー）</button>
    </div>

    <div id="parent-auth-screen" class="screen">
        <h2>ディーラー認証</h2>
        <input type="password" id="pass-input" placeholder="パスワード(1231)">
        <button onclick="checkParentPass()">ログイン</button>
        <button onclick="location.reload()" class="btn-red">戻る</button>
    </div>

    <div id="parent-main-screen" class="screen">
        <div class="slots-container">
            <div id="slot-0" class="slot" onclick="showQR(0)"><span>子1</span><small>未接続</small></div>
            <div id="slot-1" class="slot" onclick="showQR(1)"><span>子2</span><small>未接続</small></div>
            <div id="slot-2" class="slot" onclick="showQR(2)"><span>子3</span><small>未接続</small></div>
        </div>

        <div style="width: 100%; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px;">
            <div class="area-label">Step 1: 全員配布</div>
            <button onclick="dealAllHole()" class="btn-blue">2枚ずつ配る</button>

            <div class="area-label">Step 2: コミュニティ</div>
            <button id="btn-flop" onclick="dealFlop()" class="btn-orange">場に3枚出す(裏側)</button>
            <button id="btn-reveal" onclick="revealOne()" class="btn-orange" style="display:none;">1枚ずつめくる</button>
            <button id="btn-turn" onclick="dealNext()" class="btn-orange" style="display:none;">次を追加(裏側)</button>
        </div>

        <button onclick="resetGame()" class="btn-red" style="margin-top:20px;">全リセット</button>
    </div>

    <div id="child-scan-screen" class="screen">
        <h2>QRスキャン</h2>
        <div id="reader" style="width: 300px; background: white;"></div>
    </div>

    <div id="child-main-screen" class="screen">
        <div id="hand-rank">役を判定中...</div>
        <div class="area-label">Your Hand</div>
        <div id="hole-cards" class="card-row"></div>
        <div class="area-label">Community Cards</div>
        <div id="community-cards" class="card-row"></div>
    </div>

    <div id="qr-modal" onclick="this.style.display='none'">
        <div id="qrcode-canvas"></div>
        <p>子に読み取らせてください</p>
    </div>

    <script>
        let peer = new Peer();
        let myId = "";
        let connections = [null, null, null];
        let deck = [];
        let p_comm = []; // 親が管理する場のカード
        let p_revealed = 0; // 何枚表か

        let c_hole = []; // 子の手札
        let c_comm = []; // 子から見た場
        let c_revealed = 0;

        peer.on('open', (id) => { myId = id; checkAutoJoin(); });

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- 親：認証 ---
        function goParentAuth() { showScreen('parent-auth-screen'); }
        function checkParentPass() {
            if (document.getElementById('pass-input').value === "1231") startParent();
            else alert("パスワードが違います");
        }

        function startParent() {
            showScreen('parent-main-screen');
            deck = createDeck();
            peer.on('connection', (conn) => {
                conn.on('open', () => {
                    const idx = conn.metadata.slot;
                    connections[idx] = conn;
                    const el = document.getElementById(`slot-${idx}`);
                    el.classList.add('connected');
                    el.querySelector('small').innerText = "接続中";
                });
            });
        }

        // フィッシャー・イェーツのシャッフル（最強のランダム）
        function createDeck() {
            const suits = ['♠', '♥', '♦', '♣'];
            const values = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
            let d = [];
            for(let s of suits) for(let v of values) d.push({v, s, c: (s==='♥'||s==='♦')?'suit-red':''});
            
            for (let i = d.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [d[i], d[j]] = [d[j], d[i]];
            }
            return d;
        }

        function showQR(idx) {
            const canvas = document.getElementById('qrcode-canvas');
            canvas.innerHTML = "";
            const joinUrl = `${window.location.origin}${window.location.pathname}?p=${myId}&s=${idx}`;
            new QRCode(canvas, { text: joinUrl, width: 200, height: 200 });
            document.getElementById('qr-modal').style.display = 'flex';
        }

        function dealAllHole() {
            connections.forEach(conn => {
                if(conn) {
                    const cards = [deck.shift(), deck.shift()];
                    conn.send({ type: 'HOLE', cards: cards });
                }
            });
        }

        function dealFlop() {
            p_comm = [deck.shift(), deck.shift(), deck.shift()];
            p_revealed = 0; // 最初は全部裏
            sync();
            document.getElementById('btn-flop').style.display = 'none';
            document.getElementById('btn-reveal').style.display = 'inline-block';
        }

        function revealOne() {
            if (p_revealed < p_comm.length) {
                p_revealed++;
                sync();
            }
            // 全部めくれたら「次を追加」を表示
            if (p_revealed >= p_comm.length) {
                document.getElementById('btn-reveal').style.display = 'none';
                if (p_comm.length < 5) document.getElementById('btn-turn').style.display = 'inline-block';
            }
        }

        function dealNext() {
            p_comm.push(deck.shift());
            sync(); // 追加した時点では p_revealed は変わらないので裏のまま
            document.getElementById('btn-turn').style.display = 'none';
            document.getElementById('btn-reveal').style.display = 'inline-block';
        }

        function sync() {
            connections.forEach(conn => {
                if(conn) conn.send({ type: 'COMM', cards: p_comm, revealed: p_revealed });
            });
        }

        function resetGame() {
            deck = createDeck();
            p_comm = []; p_revealed = 0;
            connections.forEach(conn => { if(conn) conn.send({ type: 'RESET' }); });
            document.getElementById('btn-flop').style.display = 'inline-block';
            document.getElementById('btn-reveal').style.display = 'none';
            document.getElementById('btn-turn').style.display = 'none';
        }

        // --- 子：ロジック ---
        function goChildScanner() {
            showScreen('child-scan-screen');
            const scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
                scanner.stop();
                window.location.href = text;
            });
        }

        function checkAutoJoin() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('p')) {
                const parentId = params.get('p');
                const slot = params.get('s');
                showScreen('child-main-screen');
                
                const conn = peer.connect(parentId, { metadata: { slot: parseInt(slot) } });
                conn.on('data', (data) => {
                    if (data.type === 'HOLE') { c_hole = data.cards; renderHole(); }
                    if (data.type === 'COMM') { c_comm = data.cards; c_revealed = data.revealed; renderComm(); }
                    if (data.type === 'RESET') { c_hole = []; c_comm = []; c_revealed = 0; renderHole(); renderComm(); }
                    updateRank();
                });
            }
        }

        function renderHole() {
            const area = document.getElementById('hole-cards');
            area.innerHTML = "";
            c_hole.forEach(c => {
                const div = document.createElement('div');
                div.className = `card ${c.c}`;
                div.innerHTML = `<div>${c.v}<br>${c.s}</div>`;
                area.appendChild(div);
            });
        }

        function renderComm() {
            const area = document.getElementById('community-cards');
            area.innerHTML = "";
            c_comm.forEach((c, i) => {
                const div = document.createElement('div');
                if (i < c_revealed) {
                    div.className = `card ${c.c}`;
                    div.innerHTML = `<div>${c.v}<br>${c.s}</div>`;
                } else {
                    div.className = `card back`;
                }
                area.appendChild(div);
            });
        }

        // --- 役判定 ---
        function updateRank() {
            const display = document.getElementById('hand-rank');
            if (c_hole.length < 2) { display.innerText = "カード待機中..."; return; }
            const visibleComm = c_comm.slice(0, c_revealed);
            const all = [...c_hole, ...visibleComm];
            if (all.length < 5) { display.innerText = "判定中..."; return; }
            display.innerText = judge(all);
        }

        function judge(cards) {
            const valMap = { '2':2, '3':3, '4':4, '5':5, '6':6, '7':7, '8':8, '9':9, '10':10, 'J':11, 'Q':12, 'K':13, 'A':14 };
            const suits = cards.map(c => c.s);
            const values = cards.map(c => valMap[c.v]).sort((a,b) => b-a);
            const counts = {}; values.forEach(v => counts[v] = (counts[v] || 0) + 1);
            const countArray = Object.values(counts).sort((a,b) => b-a);
            const suitCounts = {}; suits.forEach(s => suitCounts[s] = (suitCounts[s] || 0) + 1);
            const isFlush = Object.values(suitCounts).some(c => c >= 5);
            const unique = [...new Set(values)];
            if (unique.includes(14)) unique.push(1);
            unique.sort((a,b) => b-a);
            let isStr = false;
            for (let i=0; i <= unique.length - 5; i++) {
                if (unique[i] - unique[i+4] === 4) { isStr = true; break; }
            }
            if (isFlush && isStr) {
                const fSuit = Object.keys(suitCounts).find(s => suitCounts[s] >= 5);
                const fVals = cards.filter(c => c.s === fSuit).map(c => valMap[c.v]);
                if ([14,13,12,11,10].every(v => fVals.includes(v))) return "ロイヤルフラッシュ";
                return "ストレートフラッシュ";
            }
            if (countArray[0] === 4) return "フォーカード";
            if (countArray[0] === 3 && countArray[1] >= 2) return "フルハウス";
            if (isFlush) return "フラッシュ";
            if (isStr) return "ストレート";
            if (countArray[0] === 3) return "スリーカード";
            if (countArray[0] === 2 && countArray[1] === 2) return "ツーペア";
            if (countArray[0] === 2) return "ワンペア";
            return "ハイカード";
        }
    </script>
</body>
</html>
