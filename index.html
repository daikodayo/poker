<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Texas Hold'em</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --gold: #d4af37;
            --table-green: radial-gradient(circle, #1a472a 0%, #071a10 100%);
            --dark: #050505;
            --card-red: #c0392b;
            --c1: #ffffff; --c5: #e74c3c; --c10: #3498db; --c25: #27ae60; --c50: #f1c40f;
            --turn-green: #00ff00;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { font-family: sans-serif; background: var(--dark); color: white; overflow: hidden; user-select: none; width: 100vw; height: 100dvh; }
        
        .screen { display: none; height: 100dvh; width: 100vw; flex-direction: column; background: var(--table-green); position: relative; }
        .active { display: flex; }

        button { cursor: pointer; border-radius: 25px; border: 1.5px solid var(--gold); background: rgba(0,0,0,0.6); color: white; font-weight: bold; padding: 10px; transition: 0.1s; }
        button:active { transform: scale(0.95); opacity: 0.8; }
        button:disabled { opacity: 0.1 !important; cursor: default; filter: grayscale(1); pointer-events: none !important; }

        .btn-home { position: absolute; top: 10px; left: 10px; padding: 6px 15px; font-size: 10px; z-index: 2000; border-radius: 5px; }

        /* ガイドメッセージ */
        #bet-guide { 
            margin-top: 10px; color: var(--gold); font-weight: bold; font-size: 11px; 
            background: rgba(0,0,0,0.7); padding: 5px 12px; border-radius: 10px; text-align: center; min-height: 22px;
        }

        .table-container { flex: 1; position: relative; width: 100%; overflow: hidden; }
        .center-area {
            position: absolute; top: 48%; left: 50%; transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center; z-index: 50; width: 100%;
        }
        .pot-box { background: rgba(0,0,0,0.85); padding: 5px 15px; border-radius: 15px; border: 2px solid var(--gold); text-align: center; }
        .comm-row { display: flex; gap: 4px; margin-top: 10px; min-height: 50px; }

        /* プレイヤー配置 */
        .player-node { position: absolute; width: 78px; text-align: center; font-size: 9px; z-index: 100; transition: all 0.5s ease-in-out; }
        .player-node.folded { opacity: 0.25; filter: grayscale(1); }
        .p-box { background: rgba(0,0,0,0.85); padding: 5px; border-radius: 12px; border: 1.5px solid #555; position: relative; }
        .active-turn .p-box { border: 2.5px solid var(--turn-green) !important; box-shadow: 0 0 15px var(--turn-green); }
        .dealer-btn { position: absolute; top: -8px; right: -8px; width: 18px; height: 18px; background: white; color: black; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 10px; border: 1px solid #333; }

        .card { width: 30px; height: 44px; background: white; border-radius: 3px; color: black; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; border: 1px solid #999; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .card.back { background: var(--card-red) !important; border: 1.5px solid white; color: white !important; }

        /* 操作パネル */
        .bottom-panel { background: rgba(0,0,0,0.95); border-top: 1.5px solid var(--gold); padding: 10px 10px 25px 10px; z-index: 200; }
        .action-btns { display: flex; gap: 6px; width: 100%; max-width: 450px; margin: 0 auto 10px auto; }
        .action-btns button { flex: 1; padding: 14px; font-size: 12px; border-radius: 10px; }
        .chip-row { display: flex; gap: 8px; justify-content: center; }
        .chip-btn { width: 45px; height: 45px; border-radius: 50%; border: 2px dashed rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: black; font-weight: bold; cursor: pointer; box-shadow: 0 3px 0 rgba(0,0,0,0.4); }
        .chip-btn span { font-size: 8px; display: block; }
        .chip-btn.disabled { opacity: 0.2; pointer-events: none !important; }

        /* Bot管理UI */
        .bot-card { background: rgba(255,255,255,0.1); padding: 8px; border-radius: 10px; border: 1px solid var(--gold); position: relative; min-width: 75px; text-align: center; }
        .bot-card .del-btn { position: absolute; top: -5px; right: -5px; background: #ff4d4d; color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .modal { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.98); border: 2.5px solid var(--gold); padding: 25px; border-radius: 20px; z-index: 3000; display: none; flex-direction: column; align-items: center; width: 85%; max-width: 320px; box-shadow: 0 0 30px black; }
        .ranking-item { display: flex; justify-content: space-between; width: 100%; padding: 8px 0; border-bottom: 1px solid #333; }
        .scanner-frame { position: relative; width: 260px; height: 260px; border: 2px solid rgba(255,255,255,0.2); border-radius: 20px; overflow: hidden; background: #000; }
        .scan-anim { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: var(--gold); box-shadow: 0 0 15px var(--gold); animation: scanM 2.5s infinite linear; }
        @keyframes scanM { 0% { top: 0; } 100% { top: 100%; } }
    </style>
</head>
<body>

    <button class="btn-home" onclick="location.reload()">HOME</button>

    <!-- 1. メイン画面 -->
    <div id="choice-screen" class="screen active" style="justify-content:center; align-items:center;">
        <h1 style="color:var(--gold); font-size: 40px; margin-bottom:10px;">Texas Hold'em</h1>
        <p style="margin-bottom:40px; opacity:0.8; letter-spacing: 2px; font-weight:bold;">ULTIMATE TURN PRO</p>
        <button onclick="initBotGame()" style="padding:18px; font-size:18px; background:var(--gold); color:black; width:280px; border:none; margin-bottom:20px;">1人で遊ぶ (Bot 5人)</button>
        <button onclick="goParentAuth()" style="width:250px; padding:12px; margin-bottom:10px;">親(ディーラー)を開始</button>
        <button onclick="goChildScanner()" style="width:250px; padding:12px;">子(プレイヤー)で参加</button>
    </div>

    <!-- 親管理画面 -->
    <div id="parent-auth-screen" class="screen" style="justify-content:center; align-items:center;">
        <h2 style="color:var(--gold)">DEALER LOGIN</h2>
        <input type="password" id="pass-input" placeholder="Password" style="padding:15px; border-radius:10px; width:220px; text-align:center; font-size: 20px; color: black; margin-top:10px;">
        <button onclick="checkParentPass()" style="margin-top:25px; padding:12px 60px; background:var(--gold); color:black;">Login</button>
    </div>

    <div id="parent-main-screen" class="screen" style="padding-top:50px; overflow-y: auto; padding-bottom: 20px;">
        <h2 style="color:var(--gold); text-align:center; font-size: 20px;">DEALER PANEL</h2>
        <div class="pot-box" style="margin: 15px auto; width: 160px;">POT: $<span id="p-pot-val">0</span></div>
        
        <div style="display:flex; justify-content:flex-start; gap:8px; margin:15px; overflow-x: auto; padding-bottom:10px;" id="parent-slots-list">
            <div id="slot-status-0" class="p-box" style="min-width:85px; text-align:center; opacity:0.4;">P1<br><small class="st">Waiting</small><br><button onclick="showQR(0)" style="font-size:8px; width:100%; margin-top:4px;">QR</button></div>
            <div id="slot-status-1" class="p-box" style="min-width:85px; text-align:center; opacity:0.4;">P2<br><small class="st">Waiting</small><br><button onclick="showQR(1)" style="font-size:8px; width:100%; margin-top:4px;">QR</button></div>
            <div id="slot-status-2" class="p-box" style="min-width:85px; text-align:center; opacity:0.4;">P3<br><small class="st">Waiting</small><br><button onclick="showQR(2)" style="font-size:8px; width:100%; margin-top:4px;">QR</button></div>
        </div>

        <div style="background:rgba(212,175,55,0.1); padding:10px; border-radius:15px; width:90%; margin: 0 auto 15px;">
            <p style="font-size:10px; color:var(--gold); margin-bottom:10px; text-align:center;">Botを追加する</p>
            <div style="display:flex; flex-wrap:wrap; justify-content:center; gap:5px;">
                <button onclick="addBotToOnline(0)" style="font-size:10px; padding:8px;">佐藤</button>
                <button onclick="addBotToOnline(1)" style="font-size:10px; padding:8px;">高橋</button>
                <button onclick="addBotToOnline(2)" style="font-size:10px; padding:8px;">木村</button>
                <button onclick="addBotToOnline(3)" style="font-size:10px; padding:8px;">原</button>
                <button onclick="addBotToOnline(4)" style="font-size:10px; padding:8px;">西村</button>
            </div>
        </div>

        <button id="p-btn-deal" onclick="dealAllHole()" style="padding:15px; width:85%; margin: 10px auto; background:var(--gold); color:black;">試合を開始する</button>
        <button id="p-btn-flop" onclick="dealFlop()" style="padding:15px; width:85%; margin: 5px auto; display:none;">場に3枚出す</button>
        <button id="p-btn-rev" onclick="revealOne()" style="padding:15px; width:85%; margin: 5px auto; display:none; background:var(--gold); color:black;">1枚めくる</button>
        <button id="p-btn-next" onclick="dealNext()" style="padding:15px; width:85%; margin: 5px auto; display:none; background:var(--gold); color:black;">追加</button>
        <button id="p-btn-showdown" onclick="onlineShowdown()" style="padding:15px; width:85%; margin: 15px auto; display:none; color:var(--turn-green); border-color:var(--turn-green);">ラウンド終了(公開)</button>
        
        <button onclick="location.reload()" style="color:#ff4d4d; border-color:#ff4d4d; margin:20px auto; width:140px; font-size:10px; padding:8px; display:block; margin-left:auto; margin-right:auto;">Reset All</button>
    </div>

    <!-- プレイ画面 -->
    <div id="play-screen" class="screen">
        <div class="table-container" id="table-area">
            <div class="center-area">
                <div class="pot-box">
                    <div style="font-size:9px; color:var(--gold);">TOTAL POT</div>
                    <div style="font-size:22px; font-weight:bold;">$<span id="pot-val">0</span></div>
                </div>
                <div id="bet-guide">待機中...</div>
                <div class="comm-row" id="comm-cards"></div>
            </div>
        </div>
        <div id="hand-rank" style="text-align:center; color:var(--gold); font-weight:bold; height:25px; font-size:18px;"></div>
        <div class="bottom-panel">
            <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:8px; padding: 0 5px;">
                <span>BALANCE: $<span id="my-bal">1820</span></span>
                <span style="color:var(--gold)">MY BET: $<span id="my-bet-total">0</span></span>
            </div>
            <div class="action-btns">
                <button onclick="handleFold()" id="btn-fold" style="background:#333;">FOLD</button>
                <button onclick="handleCallCheck()" id="btn-call">CALL / CHECK</button>
                <button onclick="nextPhase()" id="btn-next" style="display:none; background:var(--gold); color:black; border:none;">NEXT PHASE</button>
            </div>
            <div class="chip-row">
                <div class="chip-btn" id="btn-c1" style="background:var(--c1);" onclick="addBet(1)">$1<span id="my-c1">20</span></div>
                <div class="chip-btn" id="btn-c5" style="background:var(--c5);" onclick="addBet(5)">$5<span id="my-c5">20</span></div>
                <div class="chip-btn" id="btn-c10" style="background:var(--c10);" onclick="addBet(10)">$10<span id="my-c10">20</span></div>
                <div class="chip-btn" id="btn-c25" style="background:var(--c25);" onclick="addBet(25)">$25<span id="my-c25">20</span></div>
                <div class="chip-btn" id="btn-c50" style="background:var(--c50);" onclick="addBet(50)">$50<span id="my-c50">20</span></div>
            </div>
        </div>
    </div>

    <!-- 子スキャナー -->
    <div id="child-scan-screen" class="screen" style="justify-content:center; align-items:center;">
        <h2 style="color:var(--gold); margin-bottom:20px;">Scan QR</h2>
        <div class="scanner-frame" style="position:relative; width:260px; height:260px; border:2px solid rgba(255,255,255,0.2); border-radius:20px; overflow:hidden;">
            <div id="reader" style="width:100%; height:100%;"></div>
            <div class="scan-anim" style="position:absolute; top:0; left:0; width:100%; height:2px; background:var(--gold); box-shadow: 0 0 15px var(--gold); animation: scanM 2.5s infinite linear;"></div>
        </div>
        <button onclick="location.reload()" style="margin-top:30px;">CANCEL</button>
    </div>

    <!-- モーダル -->
    <div id="result-panel" class="modal">
        <div style="color:var(--gold); font-size:12px; font-weight:bold;">ROUND WINNER</div>
        <div id="res-name" style="font-size:28px; font-weight:bold; margin:10px 0;">YOU</div>
        <div id="res-hand" style="font-size:14px; opacity:0.8; margin-bottom:20px;">-</div>
        <button id="res-next-btn" onclick="startBotRound()" style="padding:15px 50px; background:var(--gold); color:black; border:none; width:100%;">次の試合を開始</button>
    </div>
    <div id="final-panel" class="modal">
        <h2 style="color:var(--gold)">FINAL RANKING</h2>
        <div id="ranking-list" style="width:100%; margin:20px 0;"></div>
        <button onclick="location.reload()" style="padding:15px; background:var(--gold); color:black; border:none; width:100%;">EXIT</button>
    </div>

    <script>
        let peer = new Peer(), myId = "", connections = [null,null,null];
        let deck = [], players = [], commCards = [], pot = 0, phase = 0, matchCount = 0;
        let p_comm = [], p_rev = 0, p_pot = 0, isBot = false, mySlotIdx = 0;
        let dealerIdx = 0, turnIdx = 0, currentMaxBet = 0;
        const botNamesList = ["佐藤 裕子", "高橋 由美子", "木村 健二", "原 勇気", "西村 陸翔"];
        let onlineBots = [];

        peer.on('open', (id) => { myId = id; checkAutoJoin(); });

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const target = document.getElementById(id);
            if (target) target.classList.add('active');
        }

        function createDeck() {
            const suits = ['♠','♥','♦','♣'], values = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
            let d = [];
            for(let s of suits) for(let v of values) d.push({v, s, c: (s==='♥'||s==='♦') ? 'suit-red' : ''});
            for(let i=d.length-1; i>0; i--) {
                const j = Math.floor(window.crypto.getRandomValues(new Uint32Array(1))[0] % (i+1));
                [d[i],d[j]] = [d[j],d[i]];
            }
            return d;
        }

        // --- 親機能 ---
        function goParentAuth() { showScreen('parent-auth-screen'); }
        function checkParentPass() {
            if(document.getElementById('pass-input').value === "1231") { showParentPanel(); }
            else { alert("パスワードが間違っています。"); }
        }
        function showParentPanel() {
            showScreen('parent-main-screen'); deck = createDeck();
            peer.on('connection', (conn) => {
                conn.on('open', () => {
                    const slot = conn.metadata.slot; connections[slot] = conn;
                    const el = document.getElementById(`slot-status-${slot}`);
                    el.style.opacity = "1"; el.querySelector('.st').innerText = "Connected";
                    el.querySelector('.st').style.color = "#27ae60";
                    conn.on('data', (d) => {
                        if(d.type==='BET') { p_pot += d.val; syncDealer(); }
                        if(d.type==='ACTION_DONE') { turnIdx = d.nextTurn; currentMaxBet = d.maxBet; syncDealer(); }
                        if(d.type==='FOLD') syncDealer();
                    });
                });
            });
        }
        function addBotToOnline(idx) {
            if(onlineBots.includes(idx)) return;
            onlineBots.push(idx);
            updateParentBotUI();
        }
        function removeBotFromOnline(idx) {
            onlineBots = onlineBots.filter(b => b !== idx);
            updateParentBotUI();
        }
        function updateParentBotUI() {
            const list = document.getElementById('parent-slots-list');
            list.querySelectorAll('.bot-card').forEach(el => el.remove());
            onlineBots.forEach(bIdx => {
                const div = document.createElement('div');
                div.className = "bot-card";
                div.innerHTML = `<button class="del-btn" onclick="removeBotFromOnline(${bIdx})">×</button>${botNamesList[bIdx].split(' ')[0]}<br>Bot`;
                list.appendChild(div);
            });
        }
        function showQR(slot) {
            const container = document.createElement('div');
            container.style = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:4000;display:flex;flex-direction:column;align-items:center;justify-content:center;";
            container.onclick = () => container.remove();
            const canvas = document.createElement('div');
            canvas.style = "background:white;padding:20px;border-radius:15px;";
            container.appendChild(canvas);
            new QRCode(canvas, { text: `${window.location.origin}${window.location.pathname}?p=${myId}&s=${slot}`, width: 220, height: 220 });
            document.body.appendChild(container);
        }

        function dealAllHole() {
            let pList = [];
            connections.forEach((c, i) => { if(c) pList.push({id: i, type: 'human'}); });
            onlineBots.forEach(bIdx => { pList.push({id: bIdx + 10, type: 'bot', name: botNamesList[bIdx]}); });
            if(pList.length < 1) return alert("プレイヤーがいません");

            p_pot = 0; p_comm = []; p_rev = 0; currentMaxBet = 0; deck = createDeck();
            dealerIdx = pList[matchCount % pList.length].id;
            let dInListIdx = pList.findIndex(p=>p.id===dealerIdx);
            turnIdx = pList[(dInListIdx + 1) % pList.length].id;
            matchCount++;

            document.getElementById('p-btn-deal').style.display = 'none';
            document.getElementById('p-btn-flop').style.display = 'block';
            document.getElementById('p-btn-showdown').style.display = 'none';

            connections.forEach(c => c && c.send({type:'START', cards:[deck.shift(), deck.shift()], dealer: dealerIdx, turn: turnIdx, pList: pList, matchCount: matchCount}));
            syncDealer();
            checkOnlineBotTurn(pList);
        }
        function dealFlop() { p_comm = [deck.shift(), deck.shift(), deck.shift()]; p_rev = 0; syncDealer(); document.getElementById('p-btn-flop').style.display='none'; document.getElementById('p-btn-rev').style.display='inline-block'; }
        function revealOne() { if(p_rev < p_comm.length) p_rev++; syncDealer(); if(p_rev >= p_comm.length) { document.getElementById('p-btn-rev').style.display='none'; if(p_comm.length < 5) document.getElementById('p-btn-next').style.display='inline-block'; else document.getElementById('p-btn-showdown').style.display='inline-block'; } }
        function dealNext() { p_comm.push(deck.shift()); syncDealer(); document.getElementById('p-btn-next').style.display='none'; document.getElementById('p-btn-rev').style.display='inline-block'; }
        function syncDealer() { document.getElementById('p-pot-val').innerText = p_pot; connections.forEach(c => c && c.send({type:'COMM', cards:p_comm, rev:p_rev, pot:p_pot, turn: turnIdx, maxBet: currentMaxBet})); }
        function onlineShowdown() { connections.forEach(c => c && c.send({type:'SHOWDOWN'})); document.getElementById('p-btn-showdown').style.display='none'; document.getElementById('p-btn-deal').style.display='block'; document.getElementById('p-btn-deal').innerText="次の試合を開始"; }

        function checkOnlineBotTurn(pList) {
            let current = pList.find(p => p.id === turnIdx);
            if(current && current.type === 'bot') {
                setTimeout(() => {
                    p_pot += currentMaxBet; 
                    let idxInList = pList.indexOf(current);
                    turnIdx = pList[(idxInList + 1) % pList.length].id;
                    syncDealer();
                    checkOnlineBotTurn(pList);
                }, 1500);
            }
        }

        // --- 子機能 ---
        function goChildScanner() { showScreen('child-scan-screen'); const scanner = new Html5Qrcode("reader"); scanner.start({facingMode:"environment"}, {fps:10, qrbox:250}, (t) => { scanner.stop(); location.href = t; }); }
        function checkAutoJoin() {
            const params = new URLSearchParams(window.location.search);
            if(params.get('p')) {
                isBot = false; mySlotIdx = parseInt(params.get('s')); showScreen('play-screen');
                const conn = peer.connect(params.get('p'), {metadata:{slot:mySlotIdx}});
                window.activeConn = conn;
                conn.on('data', (d) => {
                    if(d.type==='START') {
                        players = [];
                        d.pList.forEach(pInfo => { players.push({ id: pInfo.id, name: pInfo.type==='human' ? (pInfo.id===mySlotIdx?"YOU":"P"+(pInfo.id+1)) : pInfo.name, bal: players.length ? (players.find(p=>p.id===pInfo.id)?.bal || 1820) : 1820, cards: [], chips: {1:20,5:20,10:20,25:20,50:20}, isFolded: false, currentBet: 0, isConnected: true, hasActed: false }); });
                        players.find(p=>p.id===mySlotIdx).cards = d.cards;
                        players.find(p=>p.id===mySlotIdx).chips = {1:20,5:20,10:20,25:20,50:20};
                        dealerIdx = d.dealer; turnIdx = d.turn; phase = 0; matchCount = d.matchCount;
                        document.getElementById('result-panel').style.display = 'none';
                    }
                    if(d.type==='COMM') { commCards = d.cards; p_rev = d.rev; pot = d.pot; turnIdx = d.turn; currentMaxBet = d.maxBet; }
                    if(d.type==='SHOWDOWN') { phase = 4; determineWinner(); }
                    renderTable();
                });
            }
        }

        // --- BOTモード ---
        function initBotGame() {
            isBot = true; matchCount = 0; mySlotIdx = 0; dealerIdx = -1;
            players = [];
            players.push({ id: 0, name: "YOU", bal: 1820, cards: [], chips: {1:20,5:20,10:20,25:20,50:20}, isFolded: false, currentBet: 0, isConnected: true, hasActed: false });
            for(let i=0; i<5; i++) { players.push({ id: i+1, name: botNamesList[i], bal: 1820, cards: [], chips: {1:20,5:20,10:20,25:20,50:20}, isFolded: false, currentBet: 0, isConnected: true, hasActed: false }); }
            startBotRound();
        }
        function startBotRound() {
            matchCount++; if(matchCount > 5) return showFinalResults();
            phase = 0; pot = 0; p_rev = 0; currentMaxBet = 0;
            dealerIdx = players[matchCount % players.length].id;
            turnIdx = players[(players.findIndex(p=>p.id===dealerIdx) + 1) % players.length].id;
            deck = createDeck(); commCards = [];
            players.forEach(p => { p.cards = [deck.shift(), deck.shift()]; p.isFolded = false; p.currentBet = 0; p.hasActed = false; p.chips = {1:20, 5:20, 10:20, 25:20, 50:20}; });
            showScreen('play-screen'); document.getElementById('match-display').innerText = `ROUND ${matchCount}/5`;
            document.getElementById('btn-next').style.display = 'none';
            document.getElementById('btn-call').style.display = 'inline-block';
            document.getElementById('btn-fold').style.display = 'inline-block';
            document.getElementById('result-panel').style.display = 'none';
            renderTable(); checkBotTurn();
        }

        function renderTable() {
            const area = document.getElementById('table-area');
            area.querySelectorAll('.player-node').forEach(n => n.remove());
            const rect = area.getBoundingClientRect();
            const radiusX = rect.width * 0.38, radiusY = rect.height * 0.36;
            const centerX = rect.width / 2, centerY = rect.height / 2;
            const activeOnes = players.filter(p => p.isConnected);

            activeOnes.forEach((p, idx) => {
                const node = document.createElement('div');
                node.className = 'player-node' + (p.isFolded ? ' folded' : '') + (p.id === turnIdx ? ' active-turn' : '');
                const angle = ((players.indexOf(p) - players.findIndex(x=>x.id===mySlotIdx)) * (360 / activeOnes.length) + 90) * (Math.PI / 180);
                node.style.left = (centerX + radiusX * Math.cos(angle) - 39) + 'px';
                node.style.top = (centerY + radiusY * Math.sin(angle) - 35) + 'px';
                node.innerHTML = `<div class="p-box">${p.id === dealerIdx ? '<div class="dealer-btn">D</div>' : ''}<div style="color:var(--gold); font-weight:bold; font-size:10px;">${p.name}</div><div>$${p.bal}</div><div style="display:flex; justify-content:center; gap:2px; margin-top:3px;" id="hand-${p.id}"></div><div style="font-size:8px; color:var(--gold); margin-top:2px;">$${p.currentBet}</div></div>`;
                area.appendChild(node);
                const hand = document.getElementById('hand-'+p.id);
                p.cards.forEach(c => {
                    const cardDiv = document.createElement('div');
                    const show = (p.id === mySlotIdx || (phase === 4 && !p.isFolded));
                    cardDiv.className = show ? `card ${c.c}` : 'card back';
                    if(show) cardDiv.innerHTML = `<div>${c.s}</div><div>${c.v}</div>`;
                    hand.appendChild(cardDiv);
                });
            });

            document.getElementById('pot-val').innerText = pot;
            const me = players.find(p=>p.id===mySlotIdx);
            if(!me) return;
            document.getElementById('my-bal').innerText = me.bal;
            document.getElementById('my-bet-total').innerText = me.currentBet;
            
            const commArea = document.getElementById('comm-cards'); commArea.innerHTML = "";
            commCards.forEach((c, i) => {
                const div = document.createElement('div');
                const show = (i < p_rev);
                div.className = show ? `card ${c.c}` : 'card back';
                if(show) div.innerHTML = `<div>${c.s}</div><div>${c.v}</div>`;
                commArea.appendChild(div);
            });

            const callAmt = currentMaxBet - me.currentBet;
            const myTurn = (turnIdx === mySlotIdx);
            document.getElementById('bet-guide').innerText = myTurn ? (callAmt > 0 ? `あと $${callAmt} 出してください` : "あなたの番です") : `${players.find(p=>p.id===turnIdx)?.name || "待機中"}を待っています`;
            
            document.getElementById('btn-call').disabled = !myTurn || (me.bal < callAmt);
            document.getElementById('btn-fold').disabled = !myTurn;
            [1, 5, 10, 25, 50].forEach(v => {
                const btn = document.getElementById('btn-c'+v);
                if(btn) { btn.querySelector('span').innerText = me.chips[v]; btn.classList.toggle('disabled', !myTurn || me.chips[v] <= 0); }
            });
            const rank = document.getElementById('hand-rank');
            rank.innerText = me.isFolded ? "FOLDED" : (p_rev >= 3 ? judge([...me.cards, ...commCards.slice(0, p_rev)]) : "");
        }

        function checkBotTurn() { if (isBot && turnIdx !== mySlotIdx && turnIdx !== -1) setTimeout(botAction, 1500); }
        function botAction() {
            const bot = players.find(p=>p.id===turnIdx);
            if(!bot) return advanceTurnCheck();
            const callAmt = currentMaxBet - bot.currentBet;
            if (Math.random() < 0.1 && callAmt > 40) bot.isFolded = true;
            else { bot.bal -= callAmt; bot.currentBet += callAmt; pot += callAmt; bot.hasActed = true; }
            advanceTurnCheck();
        }

        function advanceTurnCheck() {
            const activeOnes = players.filter(p => !p.isFolded && p.isConnected);
            const allMatched = activeOnes.every(p => p.currentBet === currentMaxBet && p.hasActed);
            if (allMatched && activeOnes.length > 0) {
                turnIdx = -1;
                if(isBot) document.getElementById('btn-next').style.display = 'block';
                document.getElementById('btn-call').style.display = 'none';
                document.getElementById('btn-fold').style.display = 'none';
                document.getElementById('bet-guide').innerText = "全員一致。次へ。";
            } else {
                let idxInList = players.findIndex(p=>p.id===turnIdx);
                do { idxInList = (idxInList + 1) % players.length; turnIdx = players[idxInList].id; } 
                while (!players[idxInList].isConnected || players[idxInList].isFolded);
            }
            renderTable(); if(isBot) checkBotTurn();
        }

        function addBet(val) {
            const me = players.find(p=>p.id===mySlotIdx);
            if(me && me.chips[val] > 0 && me.bal >= val) {
                me.chips[val]--; me.bal -= val; me.currentBet += val; pot += val;
                if (me.currentBet > currentMaxBet) { currentMaxBet = me.currentBet; players.forEach(p => { if(!p.isFolded) p.hasActed = false; }); }
                me.hasActed = true;
                if (!isBot && window.activeConn) window.activeConn.send({type:'ACTION', action: 'BET', val: val, currentBet: me.currentBet});
                renderTable();
            }
        }

        function handleCallCheck() {
            const me = players.find(p=>p.id===mySlotIdx);
            const diff = currentMaxBet - me.currentBet;
            if (me.bal >= diff) {
                me.bal -= diff; me.currentBet += diff; pot += diff; me.hasActed = true;
                if (!isBot && window.activeConn) {
                    let nextIdx = (players.indexOf(me) + 1) % players.length;
                    while(!players[nextIdx].isConnected || players[nextIdx].isFolded) nextIdx = (nextIdx + 1) % players.length;
                    window.activeConn.send({type:'ACTION_DONE', nextTurn: players[nextIdx].id, maxBet: currentMaxBet});
                }
                advanceTurnCheck();
            }
        }

        function handleFold() {
            const me = players.find(p=>p.id===mySlotIdx);
            if(me) {
                me.isFolded = true;
                if (!isBot && window.activeConn) {
                    let nextIdx = (players.indexOf(me) + 1) % players.length;
                    while(!players[nextIdx].isConnected || players[nextIdx].isFolded) nextIdx = (nextIdx + 1) % players.length;
                    window.activeConn.send({type:'ACTION_DONE', nextTurn: players[nextIdx].id, maxBet: currentMaxBet});
                }
                advanceTurnCheck();
            }
        }

        function nextPhase() {
            if(phase === 0) { commCards = [deck.shift(), deck.shift(), deck.shift()]; p_rev = 3; phase = 1; }
            else if(p_rev < 5) { commCards.push(deck.shift()); p_rev++; phase++; }
            else { phase = 4; determineWinner(); return; }
            players.forEach(p => { p.currentBet = 0; p.hasActed = false; }); currentMaxBet = 0;
            let dIdx = players.findIndex(p=>p.id===dealerIdx);
            turnIdx = players[(dIdx + 1) % players.length].id;
            while(!players.find(p=>p.id===turnIdx).isConnected || players.find(p=>p.id===turnIdx).isFolded) {
                let idx = players.findIndex(p=>p.id===turnIdx);
                turnIdx = players[(idx + 1) % players.length].id;
            }
            document.getElementById('btn-next').style.display = 'none';
            document.getElementById('btn-call').style.display = 'inline-block';
            document.getElementById('btn-fold').style.display = 'inline-block';
            renderTable(); if(isBot) checkBotTurn();
        }

        function determineWinner() {
            let res = [];
            players.forEach(p => { if(p.isConnected && !p.isFolded) res.push({p, score: rv(judge([...p.cards,...commCards])), name: judge([...p.cards,...commCards])}); });
            if(res.length === 0) return startBotRound();
            res.sort((a,b) => b.score - a.score);
            const winner = res[0].p; winner.bal += pot;
            document.getElementById('res-name').innerText = winner.name;
            document.getElementById('res-hand').innerText = res[0].name + " WIN $" + pot;
            document.getElementById('result-panel').style.display = 'flex';
            document.getElementById('node-' + winner.id)?.classList.add('winner-glow');
        }

        function showFinalResults() {
            document.getElementById('result-panel').style.display = 'none';
            const ranked = [...players].filter(p=>p.isConnected).sort((a,b) => b.bal - a.bal);
            const list = document.getElementById('ranking-list'); list.innerHTML = "";
            ranked.forEach((p, i) => {
                const item = document.createElement('div'); item.className = 'ranking-item';
                item.innerHTML = `<span>${i+1}. ${p.name}</span> <span style="color:var(--gold)">$${p.bal}</span>`;
                list.appendChild(item);
            });
            showScreen('final-panel');
        }

        function rv(r) { return ["ハイカード","ワンペア","ツーペア","スリーカード","ストレート","フラッシュ","フルハウス","フォーカード","ストレートフラッシュ","ロイヤルフラッシュ"].indexOf(r); }
        function judge(cards) {
            if(cards.length < 5) return "判定中";
            const valMap = {'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13,'A':14};
            const v = cards.map(c=>valMap[c.v]).sort((a,b)=>b-a);
            const s = cards.map(c=>c.s);
            const counts = {}; v.forEach(x=>counts[x]=(counts[x]||0)+1);
            const cArr = Object.values(counts).sort((a,b)=>b-a);
            const sCounts = {}; s.forEach(x=>sCounts[x]=(sCounts[x]||0)+1);
            const isF = Object.values(sCounts).some(x=>x>=5);
            const uni = [...new Set(v)]; if(uni.includes(14)) uni.push(1); uni.sort((a,b)=>b-a);
            let isS = false; for(let i=0;i<=uni.length-5;i++) if(uni[i]-uni[i+4]===4){isS=true; break;}
            if(isF && isS) return "ストレートフラッシュ";
            if(cArr[0]===4) return "フォーカード";
            if(cArr[0]===3 && cArr[1]>=2) return "フルハウス";
            if(isF) return "フラッシュ";
            if(isS) return "ストレート";
            if(cArr[0]===3) return "スリーカード";
            if(cArr[0]===2 && cArr[1]===2) return "ツーペア";
            if(cArr[0]===2) return "ワンペア";
            return "ハイカード";
        }
        window.addEventListener('resize', () => { if(players.length > 0) renderTable(); });
    </script>
</body>
</html>
