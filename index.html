<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ポーカー・ディーラー Pro</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --poker-green: #1a472a; --accent: #f1c40f; }
        body { font-family: sans-serif; background: var(--poker-green); color: white; margin: 0; text-align: center; }
        .screen { display: none; padding: 20px; min-height: 100vh; box-sizing: border-box; flex-direction: column; align-items: center; }
        .active { display: flex; }
        
        button { padding: 15px; font-size: 18px; cursor: pointer; border-radius: 10px; border: none; background: #27ae60; color: white; margin: 10px; width: 250px; }
        input { padding: 12px; font-size: 18px; border-radius: 10px; border: none; width: 250px; margin-bottom: 20px; text-align: center; color: black; }

        .card { width: 80px; height: 120px; background: white; border-radius: 8px; color: black; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; box-shadow: 0 4px 8px rgba(0,0,0,0.5); margin: 5px; }
        .card.back { background: #c0392b; border: 4px solid white; color: white; }
        .suit-red { color: #e74c3c; }

        #qr-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
        #qrcode-canvas { background: white; padding: 20px; border-radius: 10px; }
        #reader { width: 300px; background: white; }
        .status-badge { background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; font-size: 12px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <!-- 1. 初期選択画面 -->
    <div id="choice-screen" class="screen active">
        <h1>Poker Dealer</h1>
        <div class="status-badge" id="peer-id-status">通信準備中...</div>
        <button onclick="goParentAuth()">親（ディーラー）を始める</button>
        <button onclick="goChildScanner()">子（プレイヤー）として参加</button>
    </div>

    <!-- 2. 親：認証画面 -->
    <div id="parent-auth-screen" class="screen">
        <h2>親：パスワード入力</h2>
        <input type="tel" id="pass-input" placeholder="Password: 1231">
        <button onclick="checkParentPass()">ログイン</button>
        <button onclick="location.reload()" style="background:#7f8c8d">戻る</button>
    </div>

    <!-- 3. 親：メイン画面 -->
    <div id="parent-main-screen" class="screen">
        <h2>ディーラーパネル</h2>
        <div class="card back">Deck</div>
        <div id="parent-log" style="font-size: 12px; color: #f1c40f;"></div>
        
        <div id="player-list" style="width: 100%; margin-top: 20px;">
            <div id="slot-0" style="background:rgba(255,255,255,0.1); margin:10px; padding:10px; border-radius:10px;">
                <span>子1: 未接続</span><br>
                <button onclick="showQR(0)">QR表示</button>
                <button id="deal-0" onclick="dealTo(0)" style="display:none; background:#2980b9">カードを配る</button>
            </div>
            <div id="slot-1" style="background:rgba(255,255,255,0.1); margin:10px; padding:10px; border-radius:10px;">
                <span>子2: 未接続</span><br>
                <button onclick="showQR(1)">QR表示</button>
                <button id="deal-1" onclick="dealTo(1)" style="display:none; background:#2980b9">カードを配る</button>
            </div>
            <div id="slot-2" style="background:rgba(255,255,255,0.1); margin:10px; padding:10px; border-radius:10px;">
                <span>子3: 未接続</span><br>
                <button onclick="showQR(2)">QR表示</button>
                <button id="deal-2" onclick="dealTo(2)" style="display:none; background:#2980b9">カードを配る</button>
            </div>
        </div>
    </div>

    <!-- 4. 子：スキャナー画面 -->
    <div id="child-scan-screen" class="screen">
        <h2>QRをスキャンしてください</h2>
        <div id="reader"></div>
        <button onclick="location.reload()" style="background:#7f8c8d">キャンセル</button>
    </div>

    <!-- 5. 子：ゲーム画面 -->
    <div id="child-main-screen" class="screen">
        <h2 id="child-status-text">親に接続しています...</h2>
        <div id="hand-display" style="display: flex; gap: 10px; justify-content: center;"></div>
        <div id="connection-log" style="font-size: 12px; margin-top: 20px;"></div>
    </div>

    <!-- QR表示モーダル -->
    <div id="qr-modal" onclick="this.style.display='none'">
        <div id="qrcode-canvas"></div>
        <p>子に読み取らせてください<br>(タップで閉じる)</p>
    </div>

    <script>
        let peer = new Peer();
        let myId = "";
        let connections = [null, null, null];
        let deck = [];

        // PeerJSの起動確認
        peer.on('open', (id) => {
            myId = id;
            document.getElementById('peer-id-status').innerText = "通信準備完了";
            // URLパラメータがあれば子として自動接続
            checkAutoJoin();
        });

        // --- 画面遷移 ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- 親の処理 ---
        function goParentAuth() { showScreen('parent-auth-screen'); }

        function checkParentPass() {
            if (document.getElementById('pass-input').value === "1231") {
                startParent();
            } else { alert("パスワードが違います"); }
        }

        function startParent() {
            showScreen('parent-main-screen');
            deck = createDeck();
            
            peer.on('connection', (conn) => {
                conn.on('open', () => {
                    const slotIdx = conn.metadata.slot;
                    connections[slotIdx] = conn;
                    const slotEl = document.getElementById(`slot-${slotIdx}`);
                    slotEl.querySelector('span').innerText = `子${slotIdx + 1}: 接続済み ✅`;
                    slotEl.querySelector('button').style.display = 'none';
                    document.getElementById(`deal-${slotIdx}`).style.display = 'inline-block';
                    document.getElementById('parent-log').innerText = `子${slotIdx + 1}が参加しました`;
                });
            });
        }

        function showQR(slotIdx) {
            const canvas = document.getElementById('qrcode-canvas');
            canvas.innerHTML = "";
            const joinUrl = `${window.location.origin}${window.location.pathname}?p=${myId}&s=${slotIdx}`;
            new QRCode(canvas, { text: joinUrl, width: 200, height: 200 });
            document.getElementById('qr-modal').style.display = 'flex';
        }

        function createDeck() {
            const suits = ['♠', '♥', '♦', '♣'];
            const values = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
            let d = [];
            for(let s of suits) for(let v of values) d.push({s, v, c: (s==='♥'||s==='♦')?'suit-red':''});
            return d.sort(() => Math.random() - 0.5);
        }

        function dealTo(idx) {
            if (connections[idx] && deck.length > 0) {
                const card = deck.shift();
                connections[idx].send({ type: 'CARD', card: card });
            }
        }

        // --- 子の処理 ---
        function goChildScanner() {
            showScreen('child-scan-screen');
            const scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
                scanner.stop();
                window.location.href = text; // QRの内容(URL)へリダイレクト
            });
        }

        function checkAutoJoin() {
            const params = new URLSearchParams(window.location.search);
            const parentId = params.get('p');
            const slot = params.get('s');

            if (parentId && slot !== null) {
                showScreen('child-main-screen');
                connectToParent(parentId, slot);
            }
        }

        function connectToParent(parentId, slot) {
            const log = document.getElementById('connection-log');
            log.innerText = "親に接続を試みています...";
            
            const conn = peer.connect(parentId, { metadata: { slot: parseInt(slot) } });
            
            conn.on('open', () => {
                log.innerText = "接続成功！カードを待っています...";
                document.getElementById('child-status-text').innerText = `子${parseInt(slot)+1} として参加中`;
            });

            conn.on('data', (data) => {
                if (data.type === 'CARD') {
                    const hand = document.getElementById('hand-display');
                    const c = data.card;
                    const div = document.createElement('div');
                    div.className = `card ${c.c}`;
                    div.innerHTML = `${c.v}<br>${c.s}`;
                    hand.appendChild(div);
                }
            });

            conn.on('error', (err) => {
                log.innerText = "エラーが発生しました: " + err;
            });
        }
    </script>
</body>
</html>
