<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>テキサスホールデム・プロ</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --poker-green: #1a472a; --accent: #f1c40f; --card-red: #c0392b; }
        body { font-family: sans-serif; background: var(--poker-green); color: white; margin: 0; text-align: center; overflow-x: hidden; }
        .screen { display: none; padding: 15px; min-height: 100vh; box-sizing: border-box; flex-direction: column; align-items: center; }
        .active { display: flex; }
        
        button { padding: 12px; font-size: 16px; cursor: pointer; border-radius: 8px; border: none; background: #27ae60; color: white; margin: 5px; width: 90%; max-width: 280px; }
        .btn-blue { background: #2980b9; }
        .btn-orange { background: #e67e22; }
        .btn-red { background: #c0392b; }
        input { padding: 12px; font-size: 18px; border-radius: 8px; border: none; width: 250px; margin-bottom: 20px; text-align: center; }

        /* カードデザイン */
        .card { 
            width: 60px; height: 90px; background: white; border-radius: 6px; color: black; 
            display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; 
            box-shadow: 0 3px 6px rgba(0,0,0,0.4); position: relative;
        }
        .card.back { background: var(--card-red) !important; border: 3px solid white; color: white !important; }
        .suit-red { color: #e74c3c; }

        /* レイアウト */
        .slots-container { display: flex; justify-content: space-around; width: 100%; margin-bottom: 10px; }
        .slot { width: 70px; height: 70px; border-radius: 50%; border: 2px dashed rgba(255,255,255,0.4); font-size: 11px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .slot.connected { border-style: solid; border-color: var(--accent); background: rgba(241,196,15,0.1); }

        .area-label { font-size: 12px; color: var(--accent); margin-top: 15px; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .card-row { display: flex; gap: 8px; justify-content: center; min-height: 100px; width: 100%; flex-wrap: wrap; }

        /* 役表示 */
        #hand-rank { font-size: 24px; font-weight: bold; color: var(--accent); margin: 15px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.5); height: 30px; }

        #qr-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
        #qrcode-canvas { background: white; padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>

    <!-- 1. 選択画面 -->
    <div id="choice-screen" class="screen active">
        <h1 style="margin-top:50px;">Texas Hold'em PRO</h1>
        <button onclick="goParentAuth()">親（ディーラー）</button>
        <button onclick="goChildScanner()">子（プレイヤー）</button>
    </div>

    <!-- 2. 親：認証 -->
    <div id="parent-auth-screen" class="screen">
        <h2>ディーラー認証</h2>
        <input type="password" id="pass-input" placeholder="パスワードを入力">
        <button onclick="checkParentPass()">ログイン</button>
        <button onclick="location.reload()" class="btn-red">戻る</button>
    </div>

    <!-- 3. 親：メインパネル -->
    <div id="parent-main-screen" class="screen">
        <div class="slots-container">
            <div id="slot-0" class="slot" onclick="showQR(0)"><span>子1</span><small>未接続</small></div>
            <div id="slot-1" class="slot" onclick="showQR(1)"><span>子2</span><small>未接続</small></div>
            <div id="slot-2" class="slot" onclick="showQR(2)"><span>子3</span><small>未接続</small></div>
        </div>

        <div style="width: 100%; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px;">
            <div class="area-label">Step 1: Deal</div>
            <button onclick="dealAllHole()" class="btn-blue">全員に2枚ずつ配る</button>

            <div class="area-label">Step 2: Community</div>
            <button id="btn-flop" onclick="dealFlop()" class="btn-orange">場に3枚出す(裏面)</button>
            <button id="btn-reveal" onclick="revealOne()" class="btn-orange" style="display:none;">1枚ずつめくる</button>
            <button id="btn-turn" onclick="dealNext()" class="btn-orange" style="display:none;">次を追加(裏面)</button>
        </div>

        <button onclick="resetGame()" class="btn-red" style="margin-top:20px;">ゲームをリセット</button>
    </div>

    <!-- 4. 子：スキャナー -->
    <div id="child-scan-screen" class="screen">
        <h2>QRをスキャン</h2>
        <div id="reader" style="width: 300px; background: white;"></div>
    </div>

    <!-- 5. 子：ゲーム画面 -->
    <div id="child-main-screen" class="screen">
        <div id="hand-rank">役を判定中...</div>
        
        <div class="area-label">Your Hand</div>
        <div id="hole-cards" class="card-row"></div>
        
        <div class="area-label">Community Cards</div>
        <div id="community-cards" class="card-row"></div>
        
        <div id="status-msg" style="margin-top:20px; font-size:12px; opacity:0.6;"></div>
    </div>

    <!-- QRモーダル -->
    <div id="qr-modal" onclick="this.style.display='none'">
        <div id="qrcode-canvas"></div>
        <p>子に読み取らせてください</p>
    </div>

    <script>
        let peer = new Peer();
        let myId = "";
        let connections = [null, null, null];
        let deck = [];
        let parent_communityCards = [];
        let parent_revealedCount = 0;

        // 子側の状態保持
        let child_hole = [];
        let child_community = [];
        let child_revealed = 0;

        peer.on('open', (id) => { myId = id; checkAutoJoin(); });

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- 親：ロジック ---
        function goParentAuth() { showScreen('parent-auth-screen'); }
        function checkParentPass() {
            if (document.getElementById('pass-input').value === "1231") startParent();
            else alert("間違い");
        }

        function startParent() {
            showScreen('parent-main-screen');
            deck = createDeck();
            peer.on('connection', (conn) => {
                conn.on('open', () => {
                    const idx = conn.metadata.slot;
                    connections[idx] = conn;
                    const el = document.getElementById(`slot-${idx}`);
                    el.classList.add('connected');
                    el.querySelector('small').innerText = "接続中";
                });
            });
        }

        function createDeck() {
            const suits = ['♠', '♥', '♦', '♣'];
            const values = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
            let d = [];
            for(let s of suits) for(let v of values) d.push({v, s, c: (s==='♥'||s==='♦')?'suit-red':''});
            return d.sort(() => Math.random() - 0.5);
        }

        function showQR(idx) {
            const canvas = document.getElementById('qrcode-canvas');
            canvas.innerHTML = "";
            const joinUrl = `${window.location.origin}${window.location.pathname}?p=${myId}&s=${idx}`;
            new QRCode(canvas, { text: joinUrl, width: 200, height: 200 });
            document.getElementById('qr-modal').style.display = 'flex';
        }

        function dealAllHole() {
            connections.forEach(conn => {
                if(conn) {
                    const cards = [deck.shift(), deck.shift()];
                    conn.send({ type: 'HOLE', cards: cards });
                }
            });
        }

        function dealFlop() {
            for(let i=0; i<3; i++) parent_communityCards.push(deck.shift());
            parent_revealedCount = 0;
            syncCommunity();
            document.getElementById('btn-flop').style.display = 'none';
            document.getElementById('btn-reveal').style.display = 'inline-block';
        }

        function revealOne() {
            parent_revealedCount++;
            syncCommunity();
            if(parent_revealedCount >= parent_communityCards.length) {
                document.getElementById('btn-reveal').style.display = 'none';
                if(parent_communityCards.length < 5) document.getElementById('btn-turn').style.display = 'inline-block';
            }
        }

        function dealNext() {
            parent_communityCards.push(deck.shift());
            syncCommunity();
            document.getElementById('btn-turn').style.display = 'none';
            document.getElementById('btn-reveal').style.display = 'inline-block';
        }

        function syncCommunity() {
            connections.forEach(conn => {
                if(conn) conn.send({ type: 'COMMUNITY', cards: parent_communityCards, revealed: parent_revealedCount });
            });
        }

        function resetGame() {
            deck = createDeck();
            parent_communityCards = [];
            parent_revealedCount = 0;
            connections.forEach(conn => { if(conn) conn.send({ type: 'RESET' }); });
            document.getElementById('btn-flop').style.display = 'inline-block';
            document.getElementById('btn-reveal').style.display = 'none';
            document.getElementById('btn-turn').style.display = 'none';
        }

        // --- 子：ロジック ---
        function goChildScanner() {
            showScreen('child-scan-screen');
            const scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
                scanner.stop();
                window.location.href = text;
            });
        }

        function checkAutoJoin() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('p')) {
                const parentId = params.get('p');
                const slot = params.get('s');
                showScreen('child-main-screen');
                document.getElementById('status-msg').innerText = `Player ${parseInt(slot)+1} Connected`;
                
                const conn = peer.connect(parentId, { metadata: { slot: parseInt(slot) } });
                conn.on('data', (data) => {
                    if (data.type === 'HOLE') {
                        child_hole = data.cards;
                        renderHole();
                    }
                    if (data.type === 'COMMUNITY') {
                        child_community = data.cards;
                        child_revealed = data.revealed;
                        renderCommunity();
                    }
                    if (data.type === 'RESET') {
                        child_hole = []; child_community = []; child_revealed = 0;
                        renderHole(); renderCommunity();
                    }
                    updateHandRank();
                });
            }
        }

        function renderHole() {
            const area = document.getElementById('hole-cards');
            area.innerHTML = "";
            child_hole.forEach(c => {
                const div = document.createElement('div');
                div.className = `card ${c.c}`;
                div.innerHTML = `<div>${c.v}<br>${c.s}</div>`;
                area.appendChild(div);
            });
        }

        function renderCommunity() {
            const area = document.getElementById('community-cards');
            area.innerHTML = "";
            child_community.forEach((c, i) => {
                const div = document.createElement('div');
                if (i < child_revealed) {
                    div.className = `card ${c.c}`;
                    div.innerHTML = `<div>${c.v}<br>${c.s}</div>`;
                } else {
                    div.className = `card back`;
                }
                area.appendChild(div);
            });
        }

        // --- 役判定エンジン ---
        function updateHandRank() {
            const display = document.getElementById('hand-rank');
            if (child_hole.length < 2) {
                display.innerText = "カードをお待ちください";
                return;
            }
            
            // 表向きのカードだけを抽出
            const visibleCommunity = child_community.slice(0, child_revealed);
            const allCards = [...child_hole, ...visibleCommunity];
            
            if (allCards.length < 5) {
                display.innerText = "判定には5枚以上必要です";
                return;
            }

            const result = judgeHand(allCards);
            display.innerText = result;
        }

        function judgeHand(cards) {
            // 値を数値化
            const valMap = { '2':2, '3':3, '4':4, '5':5, '6':6, '7':7, '8':8, '9':9, '10':10, 'J':11, 'Q':12, 'K':13, 'A':14 };
            const suits = cards.map(c => c.s);
            const values = cards.map(c => valMap[c.v]).sort((a,b) => b-a);
            
            // カウント
            const counts = {};
            values.forEach(v => counts[v] = (counts[v] || 0) + 1);
            const countArray = Object.values(counts).sort((a,b) => b-a);
            
            // フラッシュチェック
            const suitCounts = {};
            suits.forEach(s => suitCounts[s] = (suitCounts[s] || 0) + 1);
            const isFlush = Object.values(suitCounts).some(c => c >= 5);
            const flushSuit = Object.keys(suitCounts).find(s => suitCounts[s] >= 5);

            // ストレートチェック
            const uniqueValues = [...new Set(values)];
            let isStraight = false;
            if (uniqueValues.includes(14)) uniqueValues.push(1); // Aを1としても扱う
            uniqueValues.sort((a,b) => b-a);
            
            for (let i=0; i <= uniqueValues.length - 5; i++) {
                if (uniqueValues[i] - uniqueValues[i+4] === 4) {
                    isStraight = true;
                    break;
                }
            }

            // ストレートフラッシュ判定
            if (isFlush && isStraight) {
                const flushCards = cards.filter(c => c.s === flushSuit).map(c => valMap[c.v]);
                if (flushCards.includes(14) && flushCards.includes(13) && flushCards.includes(12) && flushCards.includes(11) && flushCards.includes(10)) return "ロイヤルフラッシュ";
                return "ストレートフラッシュ";
            }

            if (countArray[0] === 4) return "フォーカード";
            if (countArray[0] === 3 && countArray[1] >= 2) return "フルハウス";
            if (isFlush) return "フラッシュ";
            if (isStraight) return "ストレート";
            if (countArray[0] === 3) return "スリーカード";
            if (countArray[0] === 2 && countArray[1] === 2) return "ツーペア";
            if (countArray[0] === 2) return "ワンペア";
            
            return "ハイカード";
        }
    </script>
</body>
</html>
