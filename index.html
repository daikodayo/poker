<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>本格テキサスホールデム・ディーラー</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --poker-green: #1a472a; --accent: #f1c40f; --card-red: #c0392b; }
        body { font-family: sans-serif; background: var(--poker-green); color: white; margin: 0; text-align: center; overflow-x: hidden; touch-action: manipulation; }
        .screen { display: none; padding: 15px; min-height: 100vh; box-sizing: border-box; flex-direction: column; align-items: center; }
        .active { display: flex; }
        
        button { padding: 12px; font-size: 16px; cursor: pointer; border-radius: 8px; border: none; background: #27ae60; color: white; margin: 5px; width: 90%; max-width: 280px; }
        .btn-blue { background: #2980b9; }
        .btn-orange { background: #e67e22; }
        .btn-red { background: #c0392b; }
        input { padding: 12px; font-size: 18px; border-radius: 8px; border: none; width: 250px; margin-bottom: 20px; text-align: center; }

        /* カードデザイン */
        .card { 
            width: 60px; height: 90px; background: white; border-radius: 6px; color: black; 
            display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; 
            box-shadow: 0 3px 6px rgba(0,0,0,0.4); position: relative; transition: transform 0.6s; transform-style: preserve-3d;
        }
        .card.back { background: var(--card-red); border: 3px solid white; color: white; }
        .suit-red { color: #e74c3c; }

        /* レイアウト */
        .slots-container { display: flex; justify-content: space-around; width: 100%; margin-bottom: 10px; }
        .slot { width: 70px; height: 70px; border-radius: 50%; border: 2px dashed rgba(255,255,255,0.4); font-size: 11px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .slot.connected { border-style: solid; border-color: var(--accent); background: rgba(241,196,15,0.1); }

        .area-label { font-size: 12px; color: var(--accent); margin-top: 15px; margin-bottom: 5px; }
        .card-row { display: flex; gap: 8px; justify-content: center; min-height: 100px; width: 100%; flex-wrap: wrap; }

        #qr-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
        #qrcode-canvas { background: white; padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>

    <!-- 1. 選択画面 -->
    <div id="choice-screen" class="screen active">
        <h1 style="margin-top:50px;">Texas Hold'em</h1>
        <button onclick="goParentAuth()">親（ディーラー）</button>
        <button onclick="goChildScanner()">子（プレイヤー）</button>
    </div>

    <!-- 2. 親：認証 -->
    <div id="parent-auth-screen" class="screen">
        <h2>ディーラー認証</h2>
        <input type="password" id="pass-input" placeholder="パスワードを入力">
        <button onclick="checkParentPass()">ログイン</button>
        <button onclick="location.reload()" class="btn-red">戻る</button>
    </div>

    <!-- 3. 親：メインパネル -->
    <div id="parent-main-screen" class="screen">
        <div class="slots-container">
            <div id="slot-0" class="slot" onclick="showQR(0)"><span>子1</span><small>未接続</small></div>
            <div id="slot-1" class="slot" onclick="showQR(1)"><span>子2</span><small>未接続</small></div>
            <div id="slot-2" class="slot" onclick="showQR(2)"><span>子3</span><small>未接続</small></div>
        </div>

        <div style="width: 100%; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px;">
            <div class="area-label">【ステップ1】 配布</div>
            <button onclick="dealAllHole()" class="btn-blue">全員に2枚ずつ配る</button>

            <div class="area-label">【ステップ2】 コミュニティカード</div>
            <button id="btn-flop" onclick="dealFlop()" class="btn-orange">場に3枚出す(裏面)</button>
            <button id="btn-reveal" onclick="revealOne()" class="btn-orange" style="display:none;">1枚ずつめくる</button>
            <button id="btn-turn" onclick="dealNext()" class="btn-orange" style="display:none;">次を追加(裏面)</button>
        </div>

        <button onclick="resetGame()" class="btn-red" style="margin-top:20px;">ゲームをリセット</button>
    </div>

    <!-- 4. 子：スキャナー -->
    <div id="child-scan-screen" class="screen">
        <h2>QRをスキャン</h2>
        <div id="reader" style="width: 300px; background: white;"></div>
    </div>

    <!-- 5. 子：ゲーム画面 -->
    <div id="child-main-screen" class="screen">
        <div class="area-label">あなたの手札</div>
        <div id="hole-cards" class="card-row"></div>
        
        <div class="area-label">コミュニティカード</div>
        <div id="community-cards" class="card-row"></div>
        
        <div id="status-msg" style="margin-top:20px; font-size:14px; opacity:0.7;"></div>
    </div>

    <!-- QRモーダル -->
    <div id="qr-modal" onclick="this.style.display='none'">
        <div id="qrcode-canvas"></div>
        <p>子に読み取らせてください</p>
    </div>

    <script>
        let peer = new Peer();
        let myId = "";
        let connections = [null, null, null];
        let deck = [];
        let communityCards = []; // 場に出ているカード実体
        let revealedCount = 0;   // めくった枚数

        peer.on('open', (id) => { myId = id; checkAutoJoin(); });

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- 親のロジック ---
        function goParentAuth() { showScreen('parent-auth-screen'); }
        function checkParentPass() {
            if (document.getElementById('pass-input').value === "1231") {
                startParent();
            } else { alert("パスワードが違います"); }
        }

        function startParent() {
            showScreen('parent-main-screen');
            deck = createDeck();
            peer.on('connection', (conn) => {
                conn.on('open', () => {
                    const idx = conn.metadata.slot;
                    connections[idx] = conn;
                    const el = document.getElementById(`slot-${idx}`);
                    el.classList.add('connected');
                    el.querySelector('small').innerText = "接続済";
                });
            });
        }

        function createDeck() {
            const suits = ['♠', '♥', '♦', '♣'];
            const values = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
            let d = [];
            for(let s of suits) for(let v of values) d.push({s, v, c: (s==='♥'||s==='♦')?'suit-red':''});
            return d.sort(() => Math.random() - 0.5);
        }

        function showQR(idx) {
            const canvas = document.getElementById('qrcode-canvas');
            canvas.innerHTML = "";
            const joinUrl = `${window.location.origin}${window.location.pathname}?p=${myId}&s=${idx}`;
            new QRCode(canvas, { text: joinUrl, width: 200, height: 200 });
            document.getElementById('qr-modal').style.display = 'flex';
        }

        // 全員に2枚配る
        function dealAllHole() {
            connections.forEach(conn => {
                if(conn) {
                    const cards = [deck.shift(), deck.shift()];
                    conn.send({ type: 'HOLE', cards: cards });
                }
            });
        }

        // 場に3枚（フロップ）
        function dealFlop() {
            for(let i=0; i<3; i++) communityCards.push(deck.shift());
            broadcast({ type: 'COMMUNITY_UPDATE', cards: communityCards, revealed: 0 });
            document.getElementById('btn-flop').style.display = 'none';
            document.getElementById('btn-reveal').style.display = 'inline-block';
        }

        // 1枚ずつめくる
        function revealOne() {
            revealedCount++;
            broadcast({ type: 'COMMUNITY_REVEAL', count: revealedCount });
            if(revealedCount >= communityCards.length) {
                document.getElementById('btn-reveal').style.display = 'none';
                if(communityCards.length < 5) {
                    document.getElementById('btn-turn').style.display = 'inline-block';
                    document.getElementById('btn-turn').innerText = (communityCards.length === 3 ? "4枚目(ターン)を出す" : "5枚目(リバー)を出す");
                }
            }
        }

        // 4枚目、5枚目を出す
        function dealNext() {
            communityCards.push(deck.shift());
            broadcast({ type: 'COMMUNITY_UPDATE', cards: communityCards, revealed: revealedCount });
            document.getElementById('btn-turn').style.display = 'none';
            document.getElementById('btn-reveal').style.display = 'inline-block';
        }

        function broadcast(data) {
            connections.forEach(conn => { if(conn) conn.send(data); });
        }

        function resetGame() {
            deck = createDeck();
            communityCards = [];
            revealedCount = 0;
            broadcast({ type: 'RESET' });
            document.getElementById('btn-flop').style.display = 'inline-block';
            document.getElementById('btn-reveal').style.display = 'none';
            document.getElementById('btn-turn').style.display = 'none';
            alert("リセットしました");
        }

        // --- 子のロジック ---
        function goChildScanner() {
            showScreen('child-scan-screen');
            const scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
                scanner.stop();
                window.location.href = text;
            });
        }

        function checkAutoJoin() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('p')) {
                const parentId = params.get('p');
                const slot = params.get('s');
                showScreen('child-main-screen');
                document.getElementById('status-msg').innerText = `子${parseInt(slot)+1}として接続中...`;
                
                const conn = peer.connect(parentId, { metadata: { slot: parseInt(slot) } });
                conn.on('data', (data) => {
                    if (data.type === 'HOLE') {
                        const holeArea = document.getElementById('hole-cards');
                        holeArea.innerHTML = "";
                        data.cards.forEach(c => holeArea.appendChild(createCardUI(c, true)));
                    }
                    if (data.type === 'COMMUNITY_UPDATE') {
                        renderCommunity(data.cards, data.revealed);
                    }
                    if (data.type === 'COMMUNITY_REVEAL') {
                        updateCommunityReveal(data.count);
                    }
                    if (data.type === 'RESET') {
                        document.getElementById('hole-cards').innerHTML = "";
                        document.getElementById('community-cards').innerHTML = "";
                    }
                });
            }
        }

        function createCardUI(card, isFront) {
            const div = document.createElement('div');
            div.className = isFront ? `card ${card.c}` : 'card back';
            div.innerHTML = isFront ? `<div>${card.v}<br>${card.s}</div>` : '';
            return div;
        }

        function renderCommunity(cards, revealed) {
            const area = document.getElementById('community-cards');
            area.innerHTML = "";
            cards.forEach((c, i) => {
                const isFront = i < revealed;
                const cardDiv = createCardUI(c, isFront);
                cardDiv.id = `comm-${i}`;
                // 裏側の場合は中身を隠しつつデータを保持
                if(!isFront) {
                    cardDiv.dataset.v = c.v;
                    cardDiv.dataset.s = c.s;
                    cardDiv.dataset.c = c.c;
                    cardDiv.classList.add('back');
                    cardDiv.innerHTML = "";
                }
                area.appendChild(cardDiv);
            });
        }

        function updateCommunityReveal(count) {
            for(let i=0; i<count; i++) {
                const cardDiv = document.getElementById(`comm-${i}`);
                if(cardDiv && cardDiv.classList.contains('back')) {
                    cardDiv.classList.remove('back');
                    cardDiv.classList.add(cardDiv.dataset.c);
                    cardDiv.innerHTML = `<div>${cardDiv.dataset.v}<br>${cardDiv.dataset.s}</div>`;
                }
            }
        }

    </script>
</body>
</html>
