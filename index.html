<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>テキサスホールデム・ディーラー</title>
    <!-- ライブラリ -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --poker-green: #1a472a; --card-red: #c0392b; }
        body { font-family: sans-serif; background: var(--poker-green); color: white; margin: 0; text-align: center; }
        .screen { display: none; padding: 20px; min-height: 100vh; box-sizing: border-box; flex-direction: column; align-items: center; justify-content: center; }
        .active { display: flex; }
        
        button { padding: 15px 30px; font-size: 18px; cursor: pointer; border-radius: 10px; border: none; background: #27ae60; color: white; margin: 10px; width: 80%; max-width: 300px; }
        input { padding: 12px; font-size: 18px; border-radius: 10px; border: none; width: 80%; max-width: 300px; margin-bottom: 20px; text-align: center; }

        /* カードデザイン */
        .card { width: 80px; height: 120px; background: white; border-radius: 8px; color: black; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; position: relative; box-shadow: 0 4px 8px rgba(0,0,0,0.5); }
        .card.back { background: var(--card-red); border: 4px solid white; }
        .suit-red { color: #e74c3c; }

        /* QRモーダル */
        #qr-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; flex-direction: column; align-items: center; justify-content: center; }
        #qrcode-canvas { background: white; padding: 20px; border-radius: 10px; }

        /* スキャナー */
        #reader { width: 300px; background: white; margin: 20px auto; }

        /* 手札 */
        #hand-display { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
    </style>
</head>
<body>

    <!-- 1. 役割選択画面 -->
    <div id="choice-screen" class="screen active">
        <h1>テキサスホールデム</h1>
        <button onclick="goParentAuth()">親（ディーラー）</button>
        <button onclick="goChildScanner()">子（プレイヤー）</button>
    </div>

    <!-- 2. 親：認証画面 -->
    <div id="parent-auth-screen" class="screen">
        <h2>親用ログイン</h2>
        <input type="password" id="pass-input" placeholder="パスワードを入力">
        <button onclick="checkParentPass()">ログイン</button>
        <button onclick="backToMain()" style="background:#95a5a6">戻る</button>
    </div>

    <!-- 3. 親：メイン画面 -->
    <div id="parent-main-screen" class="screen">
        <h3>ディーラー操作パネル</h3>
        <p>山札からスワイプ（クリック）して配布</p>
        <div class="card back"></div>
        
        <div style="margin-top: 30px; width: 100%;">
            <div id="player-controls">
                <!-- 子1 -->
                <div style="border: 1px solid rgba(255,255,255,0.3); margin: 5px; padding: 10px;">
                    <button id="qr-btn-0" onclick="showQR(0)">子1：QR表示</button>
                    <button id="deal-btn-0" onclick="dealTo(0)" style="background:#2980b9; display:none;">子1へ配る</button>
                </div>
                <!-- 子2 -->
                <div style="border: 1px solid rgba(255,255,255,0.3); margin: 5px; padding: 10px;">
                    <button id="qr-btn-1" onclick="showQR(1)">子2：QR表示</button>
                    <button id="deal-btn-1" onclick="dealTo(1)" style="background:#2980b9; display:none;">子2へ配る</button>
                </div>
                <!-- 子3 -->
                <div style="border: 1px solid rgba(255,255,255,0.3); margin: 5px; padding: 10px;">
                    <button id="qr-btn-2" onclick="showQR(2)">子3：QR表示</button>
                    <button id="deal-btn-2" onclick="dealTo(2)" style="background:#2980b9; display:none;">子3へ配る</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. 子：スキャナー画面 -->
    <div id="child-scan-screen" class="screen">
        <h2>QRコードをスキャン</h2>
        <div id="reader"></div>
        <button onclick="backToMain()" style="background:#95a5a6">キャンセル</button>
    </div>

    <!-- 5. 子：ゲーム画面 -->
    <div id="child-main-screen" class="screen">
        <h2 id="child-title">接続中...</h2>
        <div id="hand-display"></div>
    </div>

    <!-- QR表示モーダル -->
    <div id="qr-modal" onclick="closeQR()">
        <div id="qrcode-canvas"></div>
        <p style="color:white; margin-top:10px;">タップで閉じる</p>
    </div>

    <script>
        let peer = new Peer();
        let myId = "";
        let connections = [null, null, null]; // 子1, 2, 3 の接続
        let deck = [];

        // --- 画面切り替え ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function backToMain() { showScreen('choice-screen'); }

        // --- 親：認証 ---
        function goParentAuth() { showScreen('parent-auth-screen'); }

        function checkParentPass() {
            if (document.getElementById('pass-input').value === "1231") {
                startParent();
            } else {
                alert("パスワードが違います");
            }
        }

        function startParent() {
            showScreen('parent-main-screen');
            deck = createDeck();
            peer.on('open', (id) => { myId = id; });
            
            peer.on('connection', (conn) => {
                // 接続時に送られてくるメタデータ（playerIndex）を確認
                conn.on('open', () => {
                    const idx = conn.metadata.playerIndex;
                    connections[idx] = conn;
                    document.getElementById(`qr-btn-${idx}`).style.display = 'none';
                    document.getElementById(`deal-btn-${idx}`).style.display = 'inline-block';
                    document.getElementById(`deal-btn-${idx}`).innerText = `子${idx+1}へ配る (接続中)`;
                });
            });
        }

        // QR表示
        function showQR(idx) {
            const modal = document.getElementById('qr-modal');
            const canvas = document.getElementById('qrcode-canvas');
            canvas.innerHTML = "";
            const joinUrl = `${window.location.origin}${window.location.pathname}?parent=${myId}&slot=${idx}`;
            new QRCode(canvas, { text: joinUrl, width: 200, height: 200 });
            modal.style.display = 'flex';
        }

        function closeQR() { document.getElementById('qr-modal').style.display = 'none'; }

        // 配布（親にはカードが見えない）
        function dealTo(idx) {
            if (connections[idx] && deck.length > 0) {
                const card = deck.shift();
                connections[idx].send({ type: 'DEAL', card: card });
            }
        }

        function createDeck() {
            const suits = ['♠', '♥', '♦', '♣'];
            const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            let d = [];
            for (let s of suits) {
                for (let v of values) {
                    d.push({ suit: s, value: v, color: (s === '♥' || s === '♦') ? 'suit-red' : '' });
                }
            }
            return d.sort(() => Math.random() - 0.5);
        }

        // --- 子：スキャン & ゲーム ---
        function goChildScanner() {
            showScreen('child-scan-screen');
            const html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                (decodedText) => {
                    html5QrCode.stop();
                    connectToParent(decodedText);
                }
            );
        }

        function connectToParent(urlText) {
            const url = new URL(urlText);
            const parentId = url.searchParams.get('parent');
            const slot = url.searchParams.get('slot');

            showScreen('child-main-screen');
            document.getElementById('child-title').innerText = `子${parseInt(slot)+1}として参加中`;

            const conn = peer.connect(parentId, { metadata: { playerIndex: parseInt(slot) } });
            conn.on('data', (data) => {
                if (data.type === 'DEAL') {
                    renderCard(data.card);
                }
            });
        }

        function renderCard(card) {
            const hand = document.getElementById('hand-display');
            const el = document.createElement('div');
            el.className = `card ${card.color}`;
            el.innerHTML = `<div>${card.value}<br>${card.suit}</div>`;
            hand.appendChild(el);
        }

        // URLにパラメータがある場合の自動処理（QRスキャン後用）
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('parent')) {
                connectToParent(window.location.href);
            }
        };

    </script>
</body>
</html>